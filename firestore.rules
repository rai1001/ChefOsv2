rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }

    function isActive() {
      return isAuthenticated() && getUserData().active == true;
    }

    function canAccessOutlet(outletId) {
      return isAuthenticated() && isActive() && (
        isAdmin() || 
        (getUserData().allowedOutlets != null && outletId in getUserData().allowedOutlets)
      );
    }

    function canManageOutlet(outletId) {
      return isAuthenticated() && isActive() && (
        isAdmin() ||
        (getUserData().adminOutletIds != null && outletId in getUserData().adminOutletIds)
      );
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }

    // Outlets collection (Root)
    match /outlets/{outletId} {
      allow list: if isAuthenticated() && isActive();
      allow get: if canAccessOutlet(outletId);
      allow create: if isAuthenticated() && isActive();
      allow update, delete: if canManageOutlet(outletId);
    }

    // Root level data collections (Flat structure)
    // For read operations
    function canReadDocument(data) {
        return isAuthenticated() && isActive() && (
            isAdmin() || (data.outletId != null && canAccessOutlet(data.outletId))
        );
    }

    // For write operations
    function canWriteDocument(data) {
        return isAuthenticated() && isActive() && (
            isAdmin() || (data.outletId != null && canManageOutlet(data.outletId))
        );
    }
    
    match /ingredients/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    match /inventory/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    match /recipes/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    match /fichasTecnicas/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    match /events/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    match /purchaseOrders/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    match /wasteRecords/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    match /haccpLogs/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    match /haccpTasks/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    match /haccpTaskCompletions/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    match /productionTasks/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    match /staff/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    match /suppliers/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    match /pccs/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    match /menus/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    match /schedule/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if canWriteDocument(request.resource.data);
        allow update: if canWriteDocument(resource.data) && canWriteDocument(request.resource.data);
        allow delete: if canWriteDocument(resource.data);
    }

    // AI Usage Metrics
    match /aiUsageMetrics/{id} {
        allow read: if canReadDocument(resource.data);
        allow create: if isAuthenticated() && isActive();
    }
    
    match /ai_pricing/{docId} {
        allow read: if isAuthenticated();
        // allow write: if false; 
    }
    
    // Exact match for the collection used in code
    match /aiConfiguration/{docId} {
        allow read: if isAuthenticated();
        allow write: if false;
    }

    match /aiBudgets/{id} {
        // id is outletId
        allow read, write: if canAccessOutlet(id);
    }

    match /aiCache/{id} {
        allow read, write: if isAuthenticated() && isActive();
    }

    match /socialManagerPosts/{id} {
        allow read: if isAuthenticated() && isActive() && (isAdmin() || (resource.data.businessId != null && canAccessOutlet(resource.data.businessId)));
        allow create: if isAuthenticated() && isActive() && (isAdmin() || (request.resource.data.businessId != null && canManageOutlet(request.resource.data.businessId)));
        allow update, delete: if isAuthenticated() && isActive() && (isAdmin() || (resource.data.businessId != null && canManageOutlet(resource.data.businessId)));
    }

    match /invitations/{invitationId} {
      allow read: if isAuthenticated() && (
        request.auth.token.email == resource.data.email || isAdmin()
      );
      allow create, update, delete: if isAdmin();
    }
  }
}
