/**
 * Script to deploy Edge Functions using Supabase Management API
 * Uses service_role key to bypass CLI limitations
 */

const fs = require('fs');
const path = require('path');
const https = require('https');

const SUPABASE_PROJECT_REF = 'xrgewhvijmrthsnrrxdw';
const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhyZ2V3aHZpam1ydGhzbnJyeGR3Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzMzMTEzMywiZXhwIjoyMDgyOTA3MTMzfQ.FXF__BF0lfd2AKeWQ97qjTZSlNqcZCUOSQphP7qpcps';

// Read all files needed for a function
function readFunctionFiles(functionName) {
  const functionPath = path.join(__dirname, 'supabase', 'functions', functionName);
  const sharedPath = path.join(__dirname, 'supabase', 'functions', '_shared');

  const files = {};

  // Read main function file
  const indexPath = path.join(functionPath, 'index.ts');
  if (fs.existsSync(indexPath)) {
    files['index.ts'] = fs.readFileSync(indexPath, 'utf8');
  }

  // Read shared files
  const sharedFiles = ['cors.ts', 'gemini-client.ts', 'prompts.ts', 'types.ts'];
  sharedFiles.forEach(file => {
    const filePath = path.join(sharedPath, file);
    if (fs.existsSync(filePath)) {
      files[`_shared/${file}`] = fs.readFileSync(filePath, 'utf8');
    }
  });

  return files;
}

// Deploy function using Management API
async function deployFunction(functionName) {
  console.log(`\nüöÄ Deploying ${functionName}...`);

  const files = readFunctionFiles(functionName);

  console.log(`üìÅ Files to upload:`);
  Object.keys(files).forEach(f => console.log(`   - ${f}`));

  // Note: The Supabase Management API for deploying functions is not publicly documented
  // The CLI uses internal endpoints that require specific authentication

  console.log(`\n‚ö†Ô∏è  Cannot deploy via Management API - endpoint not public`);
  console.log(`\nüìã Manual deployment required:`);
  console.log(`   1. Go to: https://supabase.com/dashboard/project/${SUPABASE_PROJECT_REF}/functions`);
  console.log(`   2. Click "Deploy a new function"`);
  console.log(`   3. Name: ${functionName}`);
  console.log(`   4. Copy the bundled code below:\n`);

  // Create bundled version (all code in one file)
  return createBundledFunction(functionName, files);
}

// Create a bundled version of the function (all imports inlined)
function createBundledFunction(functionName, files) {
  const indexCode = files['index.ts'];

  // Bundle all shared code into the main file
  let bundled = '// Bundled Edge Function - All dependencies inlined\n';
  bundled += '// Generated by deploy-functions.js\n\n';

  // Add shared files first (in dependency order)
  if (files['_shared/types.ts']) {
    bundled += '// === types.ts ===\n';
    bundled += files['_shared/types.ts'].replace(/export /g, '') + '\n\n';
  }

  if (files['_shared/cors.ts']) {
    bundled += '// === cors.ts ===\n';
    bundled += files['_shared/cors.ts'].replace(/export /g, '').replace(/import.*from.*;\n/g, '') + '\n\n';
  }

  if (files['_shared/gemini-client.ts']) {
    bundled += '// === gemini-client.ts ===\n';
    bundled += files['_shared/gemini-client.ts'].replace(/export /g, '').replace(/import.*from.*;\n/g, '') + '\n\n';
  }

  if (files['_shared/prompts.ts']) {
    bundled += '// === prompts.ts ===\n';
    bundled += files['_shared/prompts.ts'].replace(/export /g, '').replace(/import.*from.*;\n/g, '') + '\n\n';
  }

  // Add main function code (remove imports)
  bundled += '// === Main Function ===\n';
  bundled += indexCode.replace(/import.*from ['"]\.\.?\/_shared\/.*['"];?\n/g, '');
  bundled += indexCode.replace(/import.*from ['"]https:\/\/.*['"];?\n/g, '');

  // Write bundled version to file
  const outputPath = path.join(__dirname, `${functionName}-bundled.ts`);
  fs.writeFileSync(outputPath, bundled);

  console.log(`\n‚úÖ Bundled code written to: ${functionName}-bundled.ts`);
  console.log(`   You can copy this file and paste it in the Supabase Dashboard\n`);

  return bundled;
}

// Main execution
async function main() {
  console.log('üîß Edge Functions Deployment Tool');
  console.log(`üì¶ Project: ${SUPABASE_PROJECT_REF}\n`);

  const functions = ['scan-document', 'enrich-ingredient'];

  for (const func of functions) {
    try {
      await deployFunction(func);
    } catch (error) {
      console.error(`‚ùå Error deploying ${func}:`, error.message);
    }
  }

  console.log('\n‚ú® Done! Check the bundled files above.');
  console.log('\nüìù Next steps:');
  console.log('   1. Copy the content of each bundled file');
  console.log('   2. Paste in Supabase Dashboard when creating the function');
  console.log('   3. The functions will load the new GEMINI_API_KEY from Vault\n');
}

main().catch(console.error);
